# üîê DOCUMENTATION SYST√àME D'AUTHENTIFICATION SAGE 100

## üìã VUE D'ENSEMBLE

Le syst√®me d'authentification de la plateforme Sage 100 utilise une architecture hybride combinant **Supabase Auth** et une **session d'urgence locale** pour garantir un acc√®s administrateur fiable m√™me en cas de probl√®me avec la base de donn√©es.

## üèóÔ∏è ARCHITECTURE DU SYST√àME

### **1. AUTHENTIFICATION PRINCIPALE (Supabase)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client Web    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Supabase Auth  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ public.users    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  auth.users     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Fonctionnement :**
- **Connexion** via `supabase.auth.signInWithPassword()`
- **Session** stock√©e dans le navigateur par Supabase
- **V√©rification** du r√¥le via `auth.users.raw_user_meta_data.role`
- **Donn√©es profil** dans `public.users` (email, nom, soci√©t√©, etc.)

### **2. SYST√àME D'URGENCE (Session Locale)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client Web    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  localStorage               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  emergency_admin_session    ‚îÇ
                        ‚îÇ  {                          ‚îÇ
                        ‚îÇ    user: {...},             ‚îÇ
                        ‚îÇ    expires: timestamp       ‚îÇ
                        ‚îÇ  }                          ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Activation :**
- **URL sp√©ciale** : `/emergency-admin?code=admin`
- **Session temporaire** : 2 heures d'expiration
- **Utilisateur fictif** : `{ id: 'emergency-admin', role: 'admin' }`
- **Stockage local** : `localStorage` du navigateur

## üîí GESTION DES PERMISSIONS (RLS)

### **Politiques Row Level Security :**

#### **Pour les Admins :**
```sql
CREATE POLICY "admin_full_access" ON public.users
FOR ALL USING (
    auth.uid() IS NOT NULL AND (
        -- V√©rification dans auth.users
        EXISTS (SELECT 1 FROM auth.users WHERE id = auth.uid() AND raw_user_meta_data->>'role' = 'admin')
        -- V√©rification dans public.users
        OR EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role = 'admin')
        -- Session d'urgence
        OR auth.uid()::text = 'emergency-admin'
    )
);
```

#### **Pour les Utilisateurs :**
```sql
CREATE POLICY "user_own_access" ON public.users
FOR SELECT USING (auth.uid() = id);
```

## üõ°Ô∏è COMPOSANT DE PROTECTION DES ROUTES

### **`PrivateRoute.tsx` - Double V√©rification :**

```typescript
const PrivateRoute = ({ children, requiredRole }) => {
  const { user, loading } = useAuth();           // Session Supabase
  const emergencyUser = checkEmergencySession(); // Session d'urgence

  const currentUser = emergencyUser || user;     // Priorit√© √† l'urgence

  // V√©rifications d'acc√®s...
  return currentUser?.role === requiredRole ? children : <Redirect />;
};
```

## üîÑ PROCESSUS D'INVITATION ET D'ACTIVATION

### **1. Cr√©ation d'Invitation (Admin)**

```typescript
// Via fonction RPC s√©curis√©e
const { data } = await supabase.rpc('create_invitation_safe', {
  p_email: 'user@example.com',
  p_role: 'client',
  p_full_name: 'John Doe',
  p_company: 'ACME Corp'
});

// G√©n√©ration du token d'activation
const token = btoa(`${userId}:${email}:${timestamp}`);
const link = `${origin}/client-activation?token=${token}`;
```

### **2. Activation du Compte (Utilisateur)**

```typescript
// Validation du token (7 jours max)
const [userId, email, timestamp] = atob(token).split(':');
const isValid = (Date.now() - parseInt(timestamp)) < 7 * 24 * 60 * 60 * 1000;

// Cr√©ation du compte Supabase
await supabase.auth.signUp({ email, password });

// Mise √† jour du statut
await supabase.from('users').update({ status: 'active' }).eq('id', userId);
```

## üìä FONCTIONS RPC S√âCURIS√âES

### **Contournement des Probl√®mes RLS :**

#### **`admin_get_users()` :**
```sql
CREATE FUNCTION admin_get_users()
RETURNS TABLE (...)
SECURITY DEFINER  -- Ex√©cution avec privil√®ges √©lev√©s
AS $$
BEGIN
    -- V√©rification admin
    IF NOT (admin_check()) THEN
        RAISE EXCEPTION 'Acc√®s r√©serv√© aux administrateurs';
    END IF;

    -- Retour de tous les utilisateurs
    RETURN QUERY SELECT * FROM public.users ORDER BY client_since DESC;
END;
$$;
```

#### **`admin_get_stats()` :**
```sql
CREATE FUNCTION admin_get_stats()
RETURNS jsonb
AS $$
BEGIN
    RETURN jsonb_build_object(
        'totalUsers', (SELECT COUNT(*) FROM public.users),
        'activeUsers', (SELECT COUNT(*) FROM public.users WHERE status = 'active'),
        -- ... autres statistiques
    );
END;
$$;
```

## üéØ STRAT√âGIE DE R√âCUP√âRATION (FALLBACK)

### **Double Approche dans l'Application :**

```typescript
const loadUsers = async () => {
  try {
    // 1. Essayer la fonction RPC s√©curis√©e
    const { data: rpcData, error: rpcError } = await supabase.rpc('admin_get_users');

    if (!rpcError && rpcData) {
      setUsers(rpcData);
    } else {
      // 2. Fallback vers requ√™te directe
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .order('client_since', { ascending: false });

      if (error) throw error;
      setUsers(data);
    }
  } catch (error) {
    setMessage({ type: 'error', text: `Erreur: ${error.message}` });
  }
};
```

## üîß POINTS DE D√âBLOCAGE D'URGENCE

### **1. Acc√®s Admin Bloqu√© :**
- **URL d'urgence** : `http://localhost:8080/emergency-admin?code=admin`
- **Session temporaire** : 2h d'acc√®s complet
- **Cr√©ation d'admin** : Interface pour cr√©er un admin r√©gulier

### **2. Probl√®mes RLS :**
- **Scripts de correction** : `FIX_RLS_POLICIES.sql`, `FIX_ADMIN_AUTH_SCHEMA.sql`
- **Fonctions de contournement** : RPC avec `SECURITY DEFINER`
- **Permissions √©largies** : `GRANT ALL` sur les tables critiques

### **3. Contraintes FK :**
- **Script sp√©cialis√©** : `FIX_FK_WITH_DEPENDENCIES.sql`
- **Suppression s√©lective** : Uniquement les FK probl√©matiques vers `auth.users`
- **Pr√©servation** : Structure de base et d√©pendances importantes

## üìã AVANTAGES DE CETTE ARCHITECTURE

### **‚úÖ Robustesse :**
- **Double authentification** : Supabase + session d'urgence
- **R√©cup√©ration automatique** : Fallback en cas d'erreur
- **Scripts de r√©paration** : Solutions pour tous les probl√®mes courants

### **‚úÖ S√©curit√© :**
- **RLS multicouches** : V√©rifications dans 2 tables diff√©rentes
- **Sessions temporaires** : Expiration automatique des acc√®s d'urgence
- **Fonctions s√©curis√©es** : `SECURITY DEFINER` pour contourner RLS

### **‚úÖ Flexibilit√© :**
- **Supports multiples** : Auth normale, session d'urgence, admin externe
- **Gestion des r√¥les** : Admin et client avec permissions distinctes
- **√âvolutivit√©** : Facile d'ajouter de nouveaux r√¥les ou permissions

## üöÄ UTILISATION QUOTIDIENNE

### **Connexion Normale :**
1. `/admin` ‚Üí Connexion Supabase standard
2. V√©rification automatique du r√¥le
3. Redirection vers `/admin-dashboard`

### **Situation d'Urgence :**
1. `/emergency-admin?code=admin` ‚Üí Session temporaire
2. Acc√®s complet pendant 2h
3. Possibilit√© de cr√©er un admin r√©gulier
4. Retour au fonctionnement normal

### **Gestion des Invitations :**
1. `/admin-invitations` ‚Üí Interface compl√®te
2. Cr√©ation d'invitations avec liens automatiques
3. Suivi des statuts (pending, active, inactive)
4. Gestion des utilisateurs existants

---

**Ce syst√®me garantit un fonctionnement fiable et s√©curis√© de l'authentification, m√™me dans les situations les plus probl√©matiques.** üîê

## üåê URLS D'ACC√àS COMPL√àTES

### **üè† PAGES PUBLIQUES**
```
http://localhost:8080/                    - Page d'accueil
http://localhost:8080/about              - √Ä propos
http://localhost:8080/services           - Services Sage 100
http://localhost:8080/contact            - Contact
http://localhost:8080/blog               - Blog/Actualit√©s
```

### **üîê AUTHENTIFICATION - CLIENTS**
```
http://localhost:8080/client-login       - Connexion client
http://localhost:8080/forgot-password    - Mot de passe oubli√©
http://localhost:8080/reset-password     - R√©initialisation mot de passe
http://localhost:8080/client-activation?token=XXX  - Activation compte invit√©
```

### **üõ°Ô∏è AUTHENTIFICATION - ADMINISTRATEURS**
```
http://localhost:8080/admin              - Connexion admin
http://localhost:8080/emergency-admin?code=admin  - Acc√®s d'urgence admin
```

### **üìä ESPACES UTILISATEURS PROT√âG√âS**
```
http://localhost:8080/client-dashboard   - Dashboard client
http://localhost:8080/admin-dashboard    - Dashboard admin
http://localhost:8080/admin-invitations  - Gestion des invitations
```

### **üîß OUTILS DE DIAGNOSTIC ET TEST**
```
http://localhost:8080/auth-test          - Test d'authentification g√©n√©ral
http://localhost:8080/direct-auth-test   - Test d'authentification direct
http://localhost:8080/test-reset-password - Test reset password (dev)
```

### **‚ö†Ô∏è PAGES D'ERREUR**
```
http://localhost:8080/404                - Page non trouv√©e (catch-all)
```

## üéØ URLS AVEC PARAM√àTRES

### **üìß Activation de Compte**
```
Format: /client-activation?token=BASE64_TOKEN
Exemple: http://localhost:8080/client-activation?token=eyJ1c2VyX2lkIjoiMTIzNCIsImVtYWlsIjoiLi4uIiwgInRpbWVzdGFtcCI6IjE2OTQ5MTI0MDAifQ==

Structure du token:
- Base64(userId:email:timestamp)
- Expiration: 7 jours
- Validation automatique c√¥t√© client
```

### **üîí R√©initialisation de Mot de Passe**
```
Format: /reset-password?access_token=XXX&refresh_token=XXX&type=recovery
G√©n√©r√© automatiquement par Supabase Auth via email
```

### **üö® Acc√®s d'Urgence Admin**
```
Codes valides:
- http://localhost:8080/emergency-admin?code=admin
- http://localhost:8080/emergency-admin?code=1234
- http://localhost:8080/emergency-admin?code=sage2024emergency

Session d'urgence:
- Dur√©e: 2 heures
- Stockage: localStorage
- Auto-expiration: Oui
```

## üîÑ FLUX DE NAVIGATION

### **üíº Parcours Client Standard**
```
1. / (accueil)
2. /client-login (connexion)
3. /client-dashboard (espace client)
```

### **üõ°Ô∏è Parcours Admin Standard**
```
1. / (accueil) ou /admin (direct)
2. /admin (connexion)
3. /admin-dashboard (dashboard)
4. /admin-invitations (gestion utilisateurs)
```

### **üì® Parcours Invitation Client**
```
1. Email re√ßu avec lien d'activation
2. /client-activation?token=XXX
3. Saisie mot de passe
4. Redirection automatique vers /client-login
5. /client-dashboard (apr√®s connexion)
```

### **üÜò Parcours Urgence Admin**
```
1. /emergency-admin?code=admin (acc√®s d'urgence)
2. /admin-dashboard (dashboard temporaire)
3. Cr√©ation admin r√©gulier via interface
4. Retour √† l'authentification normale
```

## üö´ REDIRECTIONS AUTOMATIQUES

### **üîí Routes Prot√©g√©es**
```
Si non connect√©:
- /client-dashboard ‚Üí /client-login
- /admin-dashboard ‚Üí /admin
- /admin-invitations ‚Üí /admin

Si mauvais r√¥le:
- Admin ‚Üí /client-dashboard ‚ûú /admin-dashboard
- Client ‚Üí /admin-* ‚ûú Page d'erreur "Acc√®s Restreint"
```

### **üì± Routes Adaptives**
```
Apr√®s connexion r√©ussie:
- Role "admin" ‚Üí /admin-dashboard
- Role "client" ‚Üí /client-dashboard

Apr√®s activation compte:
- Role "admin" ‚Üí /admin (pour se connecter)
- Role "client" ‚Üí /client-login (pour se connecter)
```

## üîó LIENS INTERNES PRINCIPAUX

### **üìä Navigation Admin Dashboard**
```
/admin-dashboard:
  ‚îú‚îÄ‚îÄ "Inviter un utilisateur" ‚Üí /admin-invitations
  ‚îú‚îÄ‚îÄ "G√©rer les utilisateurs" ‚Üí /admin-invitations
  ‚îú‚îÄ‚îÄ "Param√®tres syst√®me" ‚Üí /admin-settings (√† cr√©er)
  ‚îî‚îÄ‚îÄ "Rapports" ‚Üí /admin-reports (√† cr√©er)
```

### **üë• Navigation Invitations**
```
/admin-invitations:
  ‚îú‚îÄ‚îÄ "Nouvel utilisateur" ‚Üí Formulaire sur m√™me page
  ‚îú‚îÄ‚îÄ "Renvoyer" ‚Üí G√©n√®re nouveau lien d'activation
  ‚îú‚îÄ‚îÄ "Supprimer" ‚Üí Supprime l'utilisateur
  ‚îî‚îÄ‚îÄ "Actualiser" ‚Üí Recharge la liste
```

## üåç URLS DE PRODUCTION

### **üöÄ Adaptation Production**
```
D√©veloppement: http://localhost:8080/
Production: https://sage-consultant.votredomaine.com/

Variables √† modifier:
- window.location.origin dans les liens d'activation
- Configurations Supabase (URL, cl√©s)
- Redirections apr√®s activation de compte
```

### **üìß Templates Email Production**
```
Liens d'activation automatiques:
${window.location.origin}/client-activation?token=${activationToken}

Exemple production:
https://sage-consultant.votredomaine.com/client-activation?token=eyJ1c2VyX2lkIjoi...
```

---

**Toutes les URLs du syst√®me sont maintenant document√©es avec leurs param√®tres, redirections et flux de navigation !** üåê‚ú®